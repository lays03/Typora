# 双信道扩展的方法

**<font color=red>大多数是基于ns2的多信道扩展（教程里面的内容ns3里面能不能直接用？）</font>**

**<font color=red>工作时间比较久远</font>**

---

<font color=red>**比较公认的一个方案：**</font>**Ramon方案**

"**通过给节点增加一组完整的信道模块、网络设备模块和链路层协议模块，来模拟一个独立的通信信道**"



## Adding Multiple Interface Support in NS-2（2007）

本技术报告的主要目标是提供一组广泛但简洁的更改，这些更改需要在模拟器框架上执行，以便首先**允许每个节点使用灵活数量的接口**，其次，**修改路由协议（现有的和新的）以便能够从该功能中受益**

- [x] 第1章 介绍了相关工作，之前已经有的一些工作
- [x] 第2章 介绍了我们基于原始 MobileNode 实现的修订架构
- [ ] 第 3 章 描述了模拟器 Tcl （工具命令语言”"Tool Command Language"）代码中所需的更改 
- [ ] 第 4 章 讨论了 C++ 中需要哪些更改文件
- [ ] 第 5 章 讨论如何调整路由代理以使用多个接口
- [ ] 第 6 章 描述了一个潜在的场景脚本，可以用来在模拟中引入多接口支持
- [ ] 第 7 章 介绍了一些开放的未来工作项目



**The requirements we would like to cope with as follows:**

1. **特定场景中的信道数量应该是可修改的**
2. **每个节点的接口数量是可变的，不需要对单个场景中的所有节点都相同**
3. **同一场景中的每个节点都可以连接到不同数量的信道****(****前面定义的信道****)**
4. **路由代理可以利用修改后的模型，但必须保留模拟器的遗留操作，以确保向后兼容**



**扩展（修改代码）的逻辑：**

**1.** **先允许节点可以添加信道**

**2.** **然后根据节点信道扩展后的架构图来修改代码，给节点添加信道**

**3.** **对路由代理进行相应的修改，来应用多信道（结合具体的路由协议来讲**



## 1. 相关工作

### 1.1 MITF

NS-2.28	AODV

修改了Tcl和AODV代理实现

**项目停止**

### 1.2 TENS

主要目标是在各个方面改进 IEEE 802.11 协议的 ns-2.1b9a 实现，例如 MAC 和物理层模型，以及为该特定 ns 版本添加多接口支持。实现的多接口模型基于多路复用，在物理层的 C++ 实现中；从 Tcl 脚本中指定的通道号用于选择适当的通道。这种多接口模型旨在模拟 IEEE 802.11 标准的 DSSS 版本使用的不同信道（也考虑了干扰），并没有真正反映我们最初的要求（见第 2 章），因为我们愿意创建一些正交接口，主要是在Tcl上，带来了实现异构接口的可能性。

此实现修改了不同的 C++ 以及 Tcl 文件。最重要的方面之一是将不同接口从 Tcl 代码合并到节点中的方式；该方法与 Hyacinth 项目使用的方法非常相似（请参阅第 1.1.3 节）。在这种情况下，在 ns-mobilenode.tcl 文件的添加接口过程中添加了一个循环，以便为每个节点创建多个完整的物理层，即包含 MAC、LL 和 IFQ（参见第 2 章）。这种方法在我们的实现中特别有用，稍后将进行讨论。

### 1.3 Hyacinth

这可能是最接近我们的作品。相应的项目最初是在纽约州立大学针对 ns-2.1b9a [2] 进行的，并且有关于如何在 ns-2.29 [3, 4] 上使用它的可用信息。它的主要缺点是它提供了相当静态的配置，其中场景中的所有节点都需要合并多达 5 个不同的接口；此外，还实现了静态（可手动配置）路由代理来使用此多通道功能，据我们所知，没有关于如何修改现有路由代理（例如 AODV）以便能够使用多接口功能。

在模拟器脚本中定义多达 11 个不同的通道（从而模拟 IEEE 802.11b 物理层）后，通过 node-config 命令将其中的五个分配给每个节点。因此，在 ns-lib.tcl 文件中添加了相应的程序。之后，同样在同一个文件中的 create-wireless-node 过程调用了 add-interface 过程五次，每次都使用不同的通道。据我们所知，无论用户是否有兴趣，这些代码段总是会被执行特定节点内的接口数量。查看 mac-802 11.cc 文件所需的更改，似乎为了保证正确的行为，场景中的所有节点都需要具有相同数量的接口（在本例中为 5），并且，此外，它们之间有很强的关系，因为它们总是根据它们所属的频道排序。

另一方面，正如已经提到的，最初的工作是基于一个静态的、手动的路由代理，它是从场景脚本中配置的（即添加和删除路由的过程）。因此，将多个接口的使用扩展到不同的路由协议并不简单。

我们在上一节中已经看到，没有一个全面的、有记录的、扩展 ns-2 模型的方法（至少根据我们最好的知识）以灵活的方式添加多个接口，也没有关于如何修改路由协议的说明，所以为了能够使用这个新功能。因此，本技术报告的主要目标是提供一组广泛但简洁的更改，这些更改需要在模拟器框架上执行，以便首先允许每个节点使用灵活数量的接口（即不同一场景中的所有节点都需要使用相同的接口），其次，修改路由协议（现有的和新的）以便能够从该功能中受益。另一方面，该文档假定您对 ns 框架有一些基本的了解。最全面的信息可能可以在其手册 [5] 中找到，但还有其他几个可用的来源。



## 2. 多个接口模型

下图显示了Mobile Node的原始架构，它由“路由代理”下面的一串模块组成，模拟了现实生活中任何主机都会拥有的不同协议栈实体:“链路层”、“MAC协议”、“ARP”、“接口队列”、“网络接口”，所有这些都连接到相同的共享无线通道

<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230109135456635.png" alt="image-20230109135456635" style="zoom:50%;" />



### 2.1 Requirements and Working Assumptions

首先，我们选择在Tcl级别上使用无线通道的不同实例，而不是在单个对象上复用它们，因为这可能与模拟器的内在架构更好地一致。在Tcl级别使用通道的不同实例还提供了更大的灵活性，并简化了相应c++文件中所需的更改。这种方法的另一个优点是，通过这种方式更容易从场景脚本中改变它们的特性(例如传输功率或能量级别)。因此，我们的实现中不会增加通道间干扰

此外，与之前关于这个问题的工作相比，我们实现的一个最相关的方面是，它应该<font color=red>**允许用户为每个节点定义不同数量的接口，即不是所有节点都需要实现相同数量的接口**</font>。此外，在单个模拟中使用的通道数量也可以参数化，节点应该能够随机连接到已定义的无线通道的子集，从而为用户提供了完全的灵活性。我们理解这种需要从场景脚本中实现的灵活性水平，对于评估不同类型的情况非常重要。

希望的结果：

1. 特定场景中的通道数量应该是可修改的。
2. 每个节点的接口数量是可变的，不需要对单个场景中的所有节点都相同。
3. 同一场景中的每个节点都可以连接到不同数量的通道(前面定义的通道)。
4. 路由代理可以利用修改后的模型，但必须保留模拟器的遗留操作，以确保向后兼容。

### 2.2 Multiple Interface Node Model

<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230109142130720.png" alt="image-20230109142130720" style="zoom:50%;" />

（改进的Mobile Node架构，支持多个接口）

每个节点拥有的原始实体链(前面显示的那个)的副本和它拥有的接口一样多。此外，不重复的单个模块是“传播模型”，因为我们最初的假设是专门用于IEEE 802.11网络，其中节点可以同时使用多个通道;在这些情况下，使用单一的传播模型是明智的。但是，扩展当前的模型以增加要使用的传播模型的数量和类型的灵活性不应该太复杂

对于传入的流量，与原来的模拟器操作没有太大区别。传入数据包通过相应的通道到达，并按升序穿过不同的实体;由于每个接口的最后一个模块，“链路层”连接到相同的公共点(“地址多路复用器”)，所有的数据包都由适当的代理(路由协议或应用程序)处理，独立于最初到达的接口。

另一方面，对于传出的流量，值得强调的是，选择适当接口的智能需要在路由代理中;可以看出，这是需要作出决定的时候。在第5章中，将广泛讨论在c++实现中为能够选择适当的接口而需要进行的更改。

## 3. change on TCL code

TCL：Tool Command Language 是一种解释性的可扩展的脚本语言，由脚本语言和相应的解释器组成，因为运行的时候是通过场景脚本进行调用tcl文件来的。

大多数使用的Tcl过程都在tcl/lib/ns-lib.tcl或tcl/lib/ns-mobilenode.tcl的文件

**ns-lib.tcl: 网络移动节点配置**

**ns-mobilenode.tcl: 网络移动节点架构扩展**

### 3.1 ns-lib.tcl

- [ ] 添加了四个新的函数

- [ ] Simulator instproc node-config args

​		#Multiple channel, multiple interfaces

<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230213134303616.png" alt="image-20230213134303616" style="zoom:50%;" />

- [ ] Simulator instproc create-wireless-node args

​	   # Adding Interface

<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230213134357340.png" alt="image-20230213134357340" style="zoom:50%;" />



### 3.2 ns-mobilenode.tcl

#### 3.2.1 add-target

<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230213134814087.png" alt="image-20230213134814087" style="zoom: 50%;" />

<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230213140128987.png" alt="image-20230213140128987" style="zoom:50%;" />

#### 3.2.2 add-target-rtagent



#### 3.2.3 add-interface



## 4. change on C++ code

#### 4.1 MobileNode.h

#### 4.2 MobileNode.cc

#### 4.3 Channel.cc

#### 4.4 mac-802_11.cc

c++代码中的最后一个更改是为了能够识别接收消息的接口。这对于路由代理正确处理多个接口是必需的，将在第5章中解释。清单4.6所示的代码需要添加到mac-802.11.cc文件。



### 5. change on Routing Protocol Code

aodv.h

aodv.cc

aodv_rtable.h

aodv_rtable.cc



#### 5.1 Introduction

毫无疑问，实现多接口模型的最终目标是利用它。因此，必须更改来自模拟器体系结构的外部代理才能使用这个新特性。在本节中，我们将展示如何调整路由代理以使用前面讨论的多接口结构，以便能够评估修改后的模型的好处。

这些更改已经在一个特殊路由协议的专有实现上进行了测试，该协议遵循与模拟器中的原始AODV实现相同的方法。尽管如此，它们是足够通用的，因此将它们扩展到其他代理应该不会太复杂。

为了充分理解本章的讨论，需要很好地了解如何在模拟器中实现路由协议。读者可以参考[6]获得关于这个问题的良好概述。

#### 5.2 Change on routing agent implementation（结合具体的路由协议）

由于我们希望每个节点的接口数量是灵活的，而且我们还希望维护模拟器的遗留行为，因此需要路由代理跟踪它正在管理的接口数量。声明路由代理类的一个新成员nIfaces以保存此信息。在我们的方法中，接口将从场景脚本(参见第6章)逐步定义，因此在开始时它的值被设置为0(即在代理的构造函数中)。

从图2.2中可以看出，路由代理需要决定将数据包传递到哪个出接口。我们声明了两个数组，targetlist和ifqueuelist，而不是使用任何路由代理都可以使用的传统的单个ifqueue和target。

第一个存储了特定节点所有接口的LL模块，而第二个存储了相应的队列。清单5.1显示了需要在路由代理的头文件中(在类声明中)添加的行。MAX_IF需要事先声明。

下一步是修改路由代理类的命令方法，以便从Tcl脚本初始化上述变量的值并使用它们。清单5.2显示了如何填充前面提到的数组、ifqueuelist和targetlist，并在节点中创建接口时获取相应的值。同时，对于添加的每个接口，我们增加维护节点使用的接口数量的变量的值。

<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230220151106753.png" alt="image-20230220151106753" style="zoom:50%;" />

<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230220151124357.png" alt="image-20230220151124357" style="zoom:50%;" />

**通过前面的所有更改，确实可以创建多接口节点**。

下一件事是在路由代理实现中添加所需的智能，这样它就可以决定哪个接口需要传输每个数据包。

另一方面，广播传输的使用在ad hoc网络的路由协议中是非常相关的(例如在路由发现过程中);当有多个可用接口时，广播包(通常是路由请求)需要通过节点拥有的所有接口传输。清单5.3显示了如何实现这一点。我们使用循环将数据包发送到所有接口，并添加一些随机时间以避免冲突。请注意，对于每个接口都发送原始数据包的副本，因为它们通过模拟器实体的路由将不同。此外，为了保存对于模拟器的传统行为，新代码只在多接口扩展已经从场景脚本初始化时执行，即nIfaces  != 0。如果不是这种情况，路由代理执行广播传输，就像没有扩展一样。

#### 5.3 Change on the Route Table

#### 5.4 Illustrative example: AODV

##### 5.4.1 Change in aodv.h

<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230220164929897.png" alt="image-20230220164929897" style="zoom:33%;" />

<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230220164910276.png" alt="image-20230220164910276" style="zoom:33%;" />

该文件中需要应用的另一个更改涉及需要如何处理路由表。正如前面所解释的，每个路由表项还必须包含一个索引，以便路由代理能够识别需要转发数据包的接口;在本例中，我们需要更改调用rt更新的方式

##### 5.4.2 Change in aodv.cc

- [ ] AODV构造函数的更改

- [ ] 对于广播的数据包的处理

- [ ] 为了正确地管理路由表，需要进行最后一组更改。每当我们向路由表中添加一个条目时，我们必须包括与该条目对应的接口。需要在recvRequest和recvReply方法中做相应的更改(分别参见清单5.16和5.17)。注意，我们还需要修改路由表的处理，因为我们必须将接口作为rt更新方法的参数。


<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230221143909305.png" alt="image-20230221143909305" style="zoom:50%;" />

- [ ] 最后，但同样重要的是，我们必须根据清单5.8所示的新定义调整rt更新方法。


<img src="C:\Users\27252\AppData\Roaming\Typora\typora-user-images\image-20230221144433523.png" alt="image-20230221144433523" style="zoom:50%;" />



##### 5.4.3 Change on the routing table implementation aodv_rtable.[cc, h]

如前所述，路由表的处理方式必须根据多接口扩展进行调整。唯一需要做的改变是取消路由表条目(aodv rt条目)的接口组件的注释。





## 6. 场景脚本

创建一个灵活的多接口模型，通过调整建立模拟场景的Tcl脚本，用户可以轻松地配置每个节点的接口数量以及场景中使用的通道总数。

在脚本的开头，我们必须初始化稍后将用作node-config命令的参数的值，这通常是这样做的。显然，必须包含的参数之一是通道类型，必须将其设置为无线通道。

此外，还需要一个新参数来设置场景中节点可能使用的最大接口数量。在下面的示例中，该参数被设置为3。































































